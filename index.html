<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Korea Mini ‚Äî Romaja (2 Pemain)</title>
<style>
  :root{
    --card:#fff; --ink:#0f172a; --muted:#64748b;
    --accent:#fb7185; --accent2:#60a5fa;
    --p1:#22c55e; --p2:#f59e0b;
    --good:#10b981; --bad:#ef4444;
    --ring:#00000012; --shadow:0 10px 30px rgba(2,6,23,.06); --r:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
    background:
      radial-gradient(1400px 900px at 10% -10%, #ffe4e6 0%, transparent 60%),
      radial-gradient(1100px 800px at 110% -10%, #dbeafe 0%, transparent 60%),
      #fff;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .wrap{max-width:820px;margin:auto;padding:12px 16px 24px}
  header{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:12px}
  h1{margin:0 0 10px;font-size:clamp(18px,2.8vw,22px)}
  .tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;background:#f1f5f9;padding:6px;border-radius:999px}
  .tab{border:0;background:transparent;padding:10px 12px;border-radius:999px;font-weight:700;font-size:14px;cursor:pointer}
  .tab[aria-pressed="true"]{background:var(--accent);color:#fff}
  .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin-top:12px}
  .row{display:flex;flex-direction:column;gap:10px}
  @media(min-width:720px){.row{flex-direction:row;flex-wrap:wrap;align-items:center}}
  .input,.select,.btn{width:100%;appearance:none;border:2px solid var(--ring);border-radius:12px;padding:12px 14px;font:600 16px/1.1 inherit;background:#fff}
  .btn{cursor:pointer;text-align:center}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:#0000}
  .muted{color:var(--muted)} .tiny{font-size:12px;color:var(--muted)}
  .stat{display:flex;flex-wrap:wrap;gap:10px;font-size:14px;margin-top:8px;color:var(--muted)}
  .tag{display:inline-block;font:700 12px/1 inherit;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px}

  /* QUIZ */
  .score{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
  .score .box{border:2px solid var(--ring);border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:800}
  .p1{border-color:#bbf7d0;background:#f0fdf4} .p2{border-color:#fde68a;background:#fffbeb}
  .turn{display:inline-flex;gap:8px;align-items:center}
  .turn .dot{width:10px;height:10px;border-radius:50%}
  .dot.p1{background:var(--p1)} .dot.p2{background:var(--p2)}
  .question{font-weight:800;text-align:center;margin-top:6px;font-size:clamp(20px,6vw,36px)}
  .choices{display:grid;gap:10px;margin-top:12px}
  .choice{border:2px solid var(--ring);border-radius:14px;background:#fff;padding:14px;font:600 16px/1.2 inherit;text-align:left}
  .choice.correct{border-color:var(--good)} .choice.wrong{border-color:var(--bad)}
  .foot{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap}

  /* FLASH */
  .flip{perspective:1000px;cursor:pointer;margin-top:8px}
  .flip-inner{position:relative;transform-style:preserve-3d;transition:transform .5s;min-height:160px;border-radius:16px;background:#fff;display:grid;place-items:center;border:2px dashed var(--ring)}
  .flip.flipped .flip-inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;display:grid;place-items:center;padding:20px;backface-visibility:hidden;border-radius:16px}
  .front{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
  .back{background:#fff;transform:rotateY(180deg)}
  .big{font-weight:800;text-align:center;padding:6px 8px;font-size:clamp(22px,6vw,42px)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üéå Korea Mini ‚Äî Romaja (2 Pemain)</h1>
    <div class="tabs" role="tablist">
      <button id="tab-quiz"   class="tab" role="tab" aria-pressed="true">Kuis</button>
      <button id="tab-flash"  class="tab" role="tab" aria-pressed="false">Flashcard</button>
      <button id="tab-custom" class="tab" role="tab" aria-pressed="false">Kustom</button>
    </div>
  </header>

  <!-- Kontrol -->
  <section class="card">
    <div class="row">
      <label><div class="tiny">Kategori</div>
        <select id="category" class="select">
          <option value="vocab" selected>Kosakata</option>
          <option value="phrases">Frasa / Kalimat</option>
        </select>
      </label>
      <label><div class="tiny">Sumber Data</div>
        <select id="datasrc" class="select">
          <option value="base" selected>Data Bawaan</option>
          <option value="merge">Gabung (Bawaan + Custom)</option>
          <option value="custom">Hanya Custom</option>
        </select>
      </label>
      <label><div class="tiny">Jumlah Soal</div>
        <select id="limit" class="select"><option>10</option><option selected>15</option><option>20</option><option>30</option></select>
      </label>
      <label class="tiny" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="hideHangul" checked /> Sembunyikan Hangul
      </label>
      <button id="btnStart" class="btn primary">Mulai / Reset</button>
    </div>

    <!-- 2 Pemain -->
    <div class="row" style="margin-top:10px">
      <label><div class="tiny">Nama Pemain 1</div><input id="p1name" class="input" value="Pemain 1"></label>
      <label><div class="tiny">Nama Pemain 2</div><input id="p2name" class="input" value="Pemain 2"></label>
      <label class="tiny" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="strictTurn" checked /> Giliran selalu bergantian (benar/tidak tetap ganti)
      </label>
    </div>

    <div class="stat">
      <span class="tag">Sumber: <span id="activeSrc">Bawaan</span></span>
      <span>‚úÖ Benar: <b id="right">0</b></span>
      <span>‚ùå Salah: <b id="wrong">0</b></span>
      <span>üî• Streak: <b id="streak">0</b></span>
      <span>üéØ Target: <b id="target">15</b></span>
    </div>
  </section>

  <!-- Panel Kuis -->
  <section id="panel-quiz" class="card">
    <div class="score">
      <div class="box p1"><span id="p1label">Pemain 1</span><span id="p1score">0</span></div>
      <div class="box p2"><span id="p2label">Pemain 2</span><span id="p2score">0</span></div>
    </div>
    <div class="turn tiny"><span class="dot p1"></span> Giliran: <b id="turnName" style="margin-left:6px">Pemain 1</b></div>

    <div class="tag" style="margin-top:8px">Kuis ‚ñ∏ Pilih arti Indonesia</div>
    <div id="hangulHint" class="muted" style="display:none;margin-top:6px;text-align:center"></div>
    <div id="question" class="question">annyeonghaseyo</div>
    <div id="choices" class="choices"></div>

    <div class="foot">
      <div class="row" style="gap:8px;flex-direction:row">
        <button id="speakQuiz" class="btn">üîä Dengar Pelafalan</button>
        <button id="btnHint" class="btn ghost">üí° Tampilkan Hangul</button>
      </div>
      <div class="row" style="gap:8px;flex-direction:row">
        <span class="muted">Soal <span id="qIndex">1</span>/<span id="qTotal">15</span></span>
        <button id="nextQ" class="btn">Lewati / Berikutnya ‚Üí</button>
      </div>
    </div>
  </section>

  <!-- Flashcard -->
  <section id="panel-flash" class="card" hidden>
    <div class="tag">Flashcard ‚ñ∏ Romaja ‚Üí Arti (ketuk kartu)</div>
    <div class="flip" id="flash">
      <div class="flip-inner">
        <div class="face front"><div id="flashFront" class="big">annyeonghaseyo</div></div>
        <div class="face back">
          <div>
            <div id="meanBack" class="big" style="margin-bottom:6px">halo/permisi</div>
            <div id="hangulBack" class="muted" style="text-align:center">ÏïàÎÖïÌïòÏÑ∏Ïöî</div>
          </div>
        </div>
      </div>
    </div>
    <div class="foot">
      <span class="muted">Kartu <span id="cardIndex">1</span>/<span id="cardTotal">15</span></span>
      <div class="row" style="gap:8px;flex-direction:row">
        <button id="speakFlash" class="btn">üîä Dengar Pelafalan</button>
        <button id="prevCard" class="btn ghost">‚Üê Sebelum</button>
        <button id="nextCard" class="btn">Berikutnya ‚Üí</button>
      </div>
    </div>
  </section>

  <!-- Kustom singkat -->
  <section id="panel-custom" class="card" hidden>
    <div class="tag">Kustom Cepat (tersimpan di perangkat)</div>
    <div class="row" style="margin-top:8px">
      <input id="inRom" class="input" placeholder="romaja (wajib)"/>
      <input id="inHan" class="input" placeholder="hangul (wajib)"/>
      <input id="inInd" class="input" placeholder="arti (wajib)"/>
      <select id="inCat" class="select"><option value="vocab">Kosakata</option><option value="phrases">Frasa</option></select>
      <button id="btnAdd" class="btn primary">Tambah</button>
    </div>
  </section>
</div>

<script>
/* ===================== DATASET LEBIH BANYAK ===================== */
const baseVocab=[
  {kr:"ÏïàÎÖïÌïòÏÑ∏Ïöî",rom:"annyeonghaseyo",id:"halo/permisi"},
  {kr:"Í∞êÏÇ¨Ìï©ÎãàÎã§",rom:"gamsahamnida",id:"terima kasih"},
  {kr:"ÏÇ¨ÎûëÌï¥",rom:"saranghae",id:"aku cinta kamu"},
  {kr:"ÎÑ§",rom:"ne",id:"iya"},
  {kr:"ÏïÑÎãàÏöî",rom:"aniyo",id:"tidak"},
  {kr:"ÎØ∏ÏïàÌï¥Ïöî",rom:"mianhaeyo",id:"maaf"},
  {kr:"Ï£ºÏÑ∏Ïöî",rom:"juseyo",id:"tolong berikan"},
  {kr:"ÏñºÎßàÏòàÏöî?",rom:"eolmayeyo?",id:"berapa harganya?"},
  {kr:"ÎßõÏûàÏñ¥Ïöî",rom:"masisseoyo",id:"enak"},
  {kr:"Í¥úÏ∞ÆÏïÑÏöî",rom:"gwaenchanayo",id:"tidak apa-apa"},
  {kr:"ÏπúÍµ¨",rom:"chingu",id:"teman"},
  {kr:"ÌïôÍµê",rom:"hakgyo",id:"sekolah"},
  {kr:"Î¨º",rom:"mul",id:"air"},
  {kr:"Î∞•",rom:"bap",id:"nasi/makanan"},
  {kr:"ÏÇ¨Í≥º",rom:"sagwa",id:"apel"},
  {kr:"ÏãúÍ∞Ñ",rom:"sigan",id:"waktu"},
  {kr:"Ïßë",rom:"jip",id:"rumah"},
  {kr:"ÏÇ¨Îûå",rom:"saram",id:"orang"},
  {kr:"ÏùòÏÇ¨",rom:"uisa",id:"dokter"},
  {kr:"Î≥ëÏõê",rom:"byeongwon",id:"rumah sakit"},
  {kr:"Î≤ÑÏä§",rom:"beoseu",id:"bus"},
  {kr:"ÏßÄÌïòÏ≤†",rom:"jihacheol",id:"kereta bawah tanah"},
  {kr:"ÌÉùÏãú",rom:"taegsi",id:"taksi"},
  {kr:"ÏãúÏû•",rom:"sijang",id:"pasar"},
  {kr:"Í∞ÄÍ≤å",rom:"gage",id:"toko"},
  {kr:"Í≥µÏõê",rom:"gongwon",id:"taman"},
  {kr:"ÏùÄÌñâ",rom:"eunhaeng",id:"bank"},
  {kr:"Îèà",rom:"don",id:"uang"},
  {kr:"Í∞ÄÍ≤©",rom:"gagyeok",id:"harga"},
  {kr:"ÏòÅÏàòÏ¶ù",rom:"yeongsujeung",id:"struk"},
  {kr:"Ïπ¥Îìú",rom:"kadeu",id:"kartu"},
  {kr:"ÌòÑÍ∏à",rom:"hyeongeum",id:"tunai"},
  {kr:"Ïñ¥Îîî",rom:"eodi",id:"di mana"},
  {kr:"Ïôú",rom:"wae",id:"kenapa"},
  {kr:"Ïñ∏Ï†ú",rom:"eonje",id:"kapan"},
  {kr:"Î¨¥Ïóá",rom:"mueot",id:"apa"},
  {kr:"ÎàÑÍµ¨",rom:"nugu",id:"siapa"},
  {kr:"ÎßéÏù¥",rom:"mani",id:"banyak"},
  {kr:"Ï°∞Í∏à",rom:"jogeum",id:"sedikit"},
  {kr:"Îß§Ïö∞",rom:"maeu",id:"sangat"},
  {kr:"Îçî",rom:"deo",id:"lebih"},
  {kr:"Îçú",rom:"deol",id:"kurang"},
  {kr:"ÏôºÏ™Ω",rom:"oenjjok",id:"kiri"},
  {kr:"Ïò§Î•∏Ï™Ω",rom:"oreunjjok",id:"kanan"},
  {kr:"Ïïû",rom:"ap",id:"depan"},
  {kr:"Îí§",rom:"dwi",id:"belakang"},
  {kr:"ÏúÑ",rom:"wi",id:"atas"},
  {kr:"ÏïÑÎûò",rom:"arae",id:"bawah"},
  {kr:"Ïò§Îäò",rom:"oneul",id:"hari ini"},
  {kr:"ÎÇ¥Ïùº",rom:"nae-il",id:"besok"},
  {kr:"Ïñ¥Ï†ú",rom:"eoje",id:"kemarin"},
  {kr:"ÏßÄÍ∏à",rom:"jigeum",id:"sekarang"},
  {kr:"Ï≤úÏ≤úÌûà",rom:"cheoncheonhi",id:"pelan-pelan"},
  {kr:"Îπ®Î¶¨",rom:"ppalli",id:"cepat"},
  {kr:"Í¥úÏ∞ÆÏäµÎãàÎã§",rom:"gwaenchanseumnida",id:"tidak apa-apa (formal)"},
  {kr:"ÎèÑÏôÄÏ£ºÏÑ∏Ïöî",rom:"dowajuseyo",id:"tolong bantu"},
  {kr:"Í∞ÄÎä•Ìï¥Ïöî",rom:"ganeunghaeyo",id:"bisa"},
  {kr:"Î∂àÍ∞ÄÎä•Ìï¥Ïöî",rom:"bulganeunghaeyo",id:"tidak bisa"},
  {kr:"ÏûÖÍµ¨",rom:"ipgu",id:"pintu masuk"},
  {kr:"Ï∂úÍµ¨",rom:"chulgu",id:"pintu keluar"},
  {kr:"ÌôîÏû•Ïã§",rom:"hwajangsil",id:"toilet"},
  {kr:"ÏãùÎãπ",rom:"sikdang",id:"restoran"},
  {kr:"Î©îÎâ¥",rom:"menyu",id:"menu"},
  {kr:"Ï∂îÏ≤ú",rom:"chucheon",id:"rekomendasi"},
  {kr:"Î¨ºÍ±¥",rom:"mulgeon",id:"barang"},
  {kr:"Ìú¥ÎåÄÌè∞",rom:"hyudaepon",id:"HP"},
  {kr:"Ïó¥Ïá†",rom:"yeolsoe",id:"kunci"},
  {kr:"Ìò∏ÌÖî",rom:"hotel",id:"hotel"},
  {kr:"ÏòàÏïΩ",rom:"yeyak",id:"reservasi"}
];
const basePhrases=[
  {kr:"Ï†ÄÎäî Ïù∏ÎèÑÎÑ§ÏãúÏïÑ ÏÇ¨ÎûåÏûÖÎãàÎã§.",rom:"jeoneun indonesia saramimnida.",id:"Saya orang Indonesia."},
  {kr:"Ï≤úÏ≤úÌûà ÎßêÌï¥ Ï£ºÏÑ∏Ïöî.",rom:"cheoncheonhi malhae juseyo.",id:"Tolong bicara pelan-pelan."},
  {kr:"ÌôîÏû•Ïã§Ïù¥ Ïñ¥ÎîîÏòàÏöî?",rom:"hwajangsil-i eodi-yeyo?",id:"Di mana toilet?"},
  {kr:"ÎèÑÏôÄÏ§Ñ Ïàò ÏûàÏñ¥Ïöî?",rom:"dowajul su isseoyo?",id:"Bisakah bantu saya?"},
  {kr:"ÏÇ¨ÏßÑ Ï∞çÏñ¥ÎèÑ ÎèºÏöî?",rom:"sajin jjigeodo dwaeyo?",id:"Boleh ambil foto?"},
  {kr:"Í∞ÄÍ≤©ÏùÑ ÍπéÏïÑ Ï£ºÏÑ∏Ïöî.",rom:"gagyeogeul kkagga juseyo.",id:"Tolong kurangi harganya."},
  {kr:"ÏòÅÏàòÏ¶ù Ï£ºÏÑ∏Ïöî.",rom:"yeongsujeung juseyo.",id:"Minta struknya."},
  {kr:"Ïã†Ïö©Ïπ¥ÎìúÎ°ú Í≤∞Ï†úÌï†Í≤åÏöî.",rom:"sinyongkadeuro gyeoljjehalgeyo.",id:"Saya bayar pakai kartu."},
  {kr:"ÌòÑÍ∏àÎßå ÎèºÏöî?",rom:"hyeongeumman dwaeyo?",id:"Hanya tunai?"},
  {kr:"Ï∂îÏ≤ú Î©îÎâ¥Í∞Ä Î≠êÏòàÏöî?",rom:"chucheon menyuga mwoyeyo?",id:"Menu rekomendasinya apa?"},
  {kr:"ÎßµÏßÄ ÏïäÍ≤å Ìï¥ Ï£ºÏÑ∏Ïöî.",rom:"maepji anke hae juseyo.",id:"Tolong jangan pedas."},
  {kr:"ÌÖåÏù¥ÌÅ¨ÏïÑÏõÉ Ìï†Í≤åÏöî.",rom:"teikeuaut halgeyo.",id:"Saya bungkus ya."},
  {kr:"Í∏∏ÏùÑ ÏûÉÏóàÏñ¥Ïöî.",rom:"gireul ilheosseoyo.",id:"Saya tersesat."},
  {kr:"ÏôºÏ™ΩÏúºÎ°ú Í∞ÄÏÑ∏Ïöî.",rom:"oenjjogeuro gaseyo.",id:"Pergi ke kiri."},
  {kr:"Ïò§Î•∏Ï™ΩÏúºÎ°ú Í∞ÄÏÑ∏Ïöî.",rom:"oreunjjogeuro gaseyo.",id:"Pergi ke kanan."},
  {kr:"Î™á ÏãúÏóê Ïó¥Ïñ¥Ïöî?",rom:"myeot sie yeoreoyo?",id:"Buka jam berapa?"},
  {kr:"ÏòàÏïΩÌñàÏñ¥Ïöî.",rom:"yeyakhaesseoyo.",id:"Saya sudah reservasi."},
  {kr:"Ï≤¥ÌÅ¨Ïù∏ ÌïòÍ≥† Ïã∂Ïñ¥Ïöî.",rom:"chekeuin hago sipeoyo.",id:"Saya ingin check-in."},
  {kr:"Î∞©ÏùÑ Î∞îÍøî Ï£ºÏÑ∏Ïöî.",rom:"bangeul bakkwo juseyo.",id:"Tolong ganti kamar."},
  {kr:"ÏÇ¨ÏßÑ Í∞ôÏù¥ Ï∞çÏùÑÍπåÏöî?",rom:"sajin gachi jjigeulkkayo?",id:"Boleh foto bareng?"},
  {kr:"Ï†ïÎßê Í≥†ÎßàÏõåÏöî.",rom:"jeongmal gomawoyo.",id:"Terima kasih banyak."},
  {kr:"Ï£ÑÏÜ°Ìï©ÎãàÎã§.",rom:"joesonghamnida",id:"Mohon maaf."},
  {kr:"Í¥úÏ∞ÆÏúºÏÑ∏Ïöî?",rom:"gwaenchan-euseyo?",id:"Anda tidak apa-apa?"},
  {kr:"Îã§Ïãú Ìïú Î≤à ÎßêÌï¥ Ï£ºÏÑ∏Ïöî.",rom:"dasi han beon malhae juseyo.",id:"Tolong ulangi sekali lagi."},
  {kr:"Ï≤úÏ≤úÌûà Ïç® Ï£ºÏÑ∏Ïöî.",rom:"cheoncheonhi sseo juseyo.",id:"Tolong tulis pelan-pelan."},
  {kr:"ÏûÖÍµ¨Îäî Ïñ¥ÎîîÏòàÏöî?",rom:"ipguneun eodiyeyo?",id:"Di mana pintu masuk?"},
  {kr:"Ï∂úÍµ¨Îäî Ïñ¥ÎîîÏòàÏöî?",rom:"chulguneun eodiyeyo?",id:"Di mana pintu keluar?"},
  {kr:"Ïù¥Í±∞ ÏûÉÏñ¥Î≤ÑÎ†∏Ïñ¥Ïöî.",rom:"igeo ilheobeoryeosseoyo.",id:"Saya kehilangan ini."},
  {kr:"ÏÇ¨ÏßÑ Î≥¥ÎÇ¥ Ï£ºÏã§ Ïàò ÏûàÏñ¥Ïöî?",rom:"sajin bonae jusil su isseoyo?",id:"Bisa kirim fotonya?"},
  {kr:"ÌÉùÏãú Î∂àÎü¨ Ï£ºÏÑ∏Ïöî.",rom:"taegsi bulleojuseyo.",id:"Tolong panggil taksi."},
  {kr:"ÏñºÎßàÎÇò Í±∏Î†§Ïöî?",rom:"eolmana geollyeoyo?",id:"Butuh waktu berapa lama?"},
  {kr:"ÏßÄÍ∏à Ï∂úÎ∞úÌï¥Ïöî.",rom:"jigeum chulbalhaeyo.",id:"Berangkat sekarang."},
  {kr:"ÎèÑÏ∞©ÌïòÎ©¥ Ïó∞ÎùΩÌï¥ Ï£ºÏÑ∏Ïöî.",rom:"dochakhameon yeollakhae juseyo.",id:"Kalau sudah sampai kabari ya."},
  {kr:"ÏÇ¨ÏßÑ Ïò¨Î†§ÎèÑ ÎèºÏöî?",rom:"sajin ollyeodo dwaeyo?",id:"Boleh unggah fotonya?"}
];

/* ===================== STORAGE + UTIL ===================== */
const LS={v:"km_duel_vocab",p:"km_duel_phr",src:"km_duel_src"};
const $=s=>document.querySelector(s);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
const vibrate=ms=>{if(navigator.vibrate) navigator.vibrate(ms)};
function speak(t,lang="ko-KR"){try{const u=new SpeechSynthesisUtterance(t);u.lang=lang;u.rate=.95;speechSynthesis.cancel();speechSynthesis.speak(u)}catch(e){}}
const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch(e){return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===================== STATE & ELEMENTS ===================== */
let mode="quiz", pool=[], idx=0, right=0, wrong=0, streak=0;
let p1={name:"Pemain 1",score:0}, p2={name:"Pemain 2",score:0}, turn=1;

const el={
  tabQuiz:$("#tab-quiz"), tabFlash:$("#tab-flash"), tabCustom:$("#tab-custom"),
  pQuiz:$("#panel-quiz"), pFlash:$("#panel-flash"), pCustom:$("#panel-custom"),
  cat:$("#category"), src:$("#datasrc"), limit:$("#limit"), hide:$("#hideHangul"),
  start:$("#btnStart"), right:$("#right"), wrong:$("#wrong"), streak:$("#streak"), target:$("#target"), srcTag:$("#activeSrc"),
  q:$("#question"), choices:$("#choices"), qIndex:$("#qIndex"), qTotal:$("#qTotal"),
  speakQ:$("#speakQuiz"), hintBtn:$("#btnHint"), hangulHint:$("#hangulHint"), nextQ:$("#nextQ"),
  flash:$("#flash"), fFront:$("#flashFront"), fMean:$("#meanBack"), fHan:$("#hangulBack"),
  fPrev:$("#prevCard"), fNext:$("#nextCard"), fSpeak:$("#speakFlash"), cIndex:$("#cardIndex"), cTotal:$("#cardTotal"),
  inRom:$("#inRom"), inHan:$("#inHan"), inInd:$("#inInd"), inCat:$("#inCat"), add:$("#btnAdd"),
  p1name:$("#p1name"), p2name:$("#p2name"), p1label:$("#p1label"), p2label:$("#p2label"),
  p1score:$("#p1score"), p2score:$("#p2score"), turnName:$("#turnName"), strictTurn:$("#strictTurn")
};
el.src.value = load(LS.src,"base"); updateSrcTag();

/* ===================== EVENTS ===================== */
[el.tabQuiz,el.tabFlash,el.tabCustom].forEach(b=>b.addEventListener("click",()=>switchMode(b.id.replace("tab-",""))));
el.limit.addEventListener("change",()=>el.target.textContent=el.limit.value);
el.src.addEventListener("change",()=>{save(LS.src,el.src.value);updateSrcTag();resetGame()});
el.hintBtn.addEventListener("click",()=>{toggle(el.hangulHint)});
el.speakQ.addEventListener("click",()=>speak(pool[idx].kr));
el.nextQ.addEventListener("click",()=>{ nextTurn(); if(idx<pool.length-1){idx++; renderQuiz();} else {finish()} });
el.flash.addEventListener("click",()=>{ el.flash.classList.toggle("flipped"); vibrate(20) });
el.fPrev.addEventListener("click",()=>{ if(idx>0){idx--; renderFlash()} });
el.fNext.addEventListener("click",()=>{ if(idx<pool.length-1){idx++; renderFlash()} });
el.fSpeak.addEventListener("click",()=>speak(pool[idx].kr));
el.add.addEventListener("click", addCustom);
el.p1name.addEventListener("input",()=>{p1.name=el.p1name.value.trim()||"Pemain 1"; refreshNames()});
el.p2name.addEventListener("input",()=>{p2.name=el.p2name.value.trim()||"Pemain 2"; refreshNames()});
$("#btnStart").addEventListener("click", resetGame);

function toggle(n){n.style.display=(n.style.display==="none"||!n.style.display)?"block":"none"}
function updateSrcTag(){ el.srcTag.textContent = el.src.value==="base"?"Bawaan":el.src.value==="merge"?"Gabung":"Hanya Custom" }
function refreshNames(){
  el.p1label.textContent=p1.name; el.p2label.textContent=p2.name; el.turnName.textContent = (turn===1?p1.name:p2.name);
}

/* ===================== DATA ===================== */
function custom(){ return {v:load(LS.v,[]), p:load(LS.p,[])} }
function dataset(){
  const src=el.src.value, cat=el.cat.value, c=custom();
  let arr=[];
  if(src==="base") arr=(cat==="vocab"? baseVocab:basePhrases);
  else if(src==="custom") arr=(cat==="vocab"? c.v:c.p);
  else arr=(cat==="vocab"? [...baseVocab,...c.v]:[...basePhrases,...c.p]);
  return arr.map(x=>({q:x.rom,a:x.id,rom:x.rom,kr:x.kr,id:x.id}));
}

/* ===================== GAME FLOW ===================== */
function resetGame(){
  // reset skor & giliran
  p1.score=p2.score=0; turn=1; refreshNames();
  el.p1score.textContent=0; el.p2score.textContent=0;

  right=wrong=streak=0; idx=0;
  el.right.textContent=0; el.wrong.textContent=0; el.streak.textContent=0;
  el.target.textContent=el.limit.value;

  const data=dataset();
  pool = shuffle([...data]).slice(0, Math.min(+el.limit.value, data.length));
  el.cTotal.textContent = pool.length; el.qTotal.textContent = pool.length;

  if(pool.length===0){ alert("Dataset kosong. Tambah data di tab Kustom atau ganti Sumber Data."); return;}
  mode==="quiz" ? renderQuiz() : renderFlash();
}
function nextTurn(){
  if(el.strictTurn.checked){ turn = (turn===1?2:1); refreshNames(); }
}
function answer(op){
  const it=pool[idx];
  const correct = (op===it.a);
  if(correct){ right++; streak++; if(turn===1) p1.score++; else p2.score++; vibrate(40); }
  else{ wrong++; streak=0; vibrate([20,40,20]); }
  el.right.textContent=right; el.wrong.textContent=wrong; el.streak.textContent=streak;
  el.p1score.textContent=p1.score; el.p2score.textContent=p2.score;

  // highlight
  [...el.choices.children].forEach(c=>c.dataset.lock=1);
  const clicked = [...el.choices.children].find(x=>x.textContent===op);
  if(clicked) clicked.classList.add(correct?"correct":"wrong");
  [...el.choices.children].find(x=>x.textContent===it.a)?.classList.add("correct");

  // pindah
  setTimeout(()=>{
    nextTurn();
    if(idx<pool.length-1){idx++; renderQuiz();} else {finish()}
  }, 650);
}
function renderQuiz(){
  const it=pool[idx];
  el.qIndex.textContent=idx+1;
  el.q.textContent=it.q;
  el.hangulHint.textContent=it.kr;
  el.hangulHint.style.display = el.hide.checked ? "none":"block";

  // opsi
  const others = shuffle(dataset().filter(x=>x.a!==it.a)).slice(0,3);
  const options = shuffle([it.a, ...others.map(o=>o.a)]);
  el.choices.innerHTML="";
  options.forEach(op=>{
    const b=document.createElement("button");
    b.className="choice"; b.textContent=op;
    b.addEventListener("click",()=>{ if(b.dataset.lock) return; answer(op); });
    el.choices.appendChild(b);
  });

  // indikator giliran (warna dot)
  el.turnName.textContent = (turn===1?p1.name:p2.name);
  document.querySelector(".turn .dot").className = "dot " + (turn===1?"p1":"p2");
}
function renderFlash(){
  const it=pool[idx];
  el.cIndex.textContent=idx+1;
  el.flash.classList.remove("flipped");
  el.fFront.textContent=it.rom; el.fMean.textContent=it.id; el.fHan.textContent=it.kr;
  el.fHan.style.display = el.hide.checked ? "none":"block";
}
function finish(){
  const total=pool.length, score=Math.round((right/total)*100);
  let winner="Seri! üéâ";
  if(p1.score>p2.score) winner=`Pemenang: ${p1.name} üèÜ`;
  else if(p2.score>p1.score) winner=`Pemenang: ${p2.name} üèÜ`;
  alert(`${winner}\n\nSkor Akhir\n${p1.name}: ${p1.score}\n${p2.name}: ${p2.score}\n\nAkurasi tim: ${score}% (Benar ${right} / ${total})`);
}

/* ===================== MODE & CUSTOM ===================== */
function switchMode(m){
  mode=m;
  el.tabQuiz.setAttribute("aria-pressed", m==="quiz");
  el.tabFlash.setAttribute("aria-pressed", m==="flash");
  el.tabCustom.setAttribute("aria-pressed", m==="custom");
  el.pQuiz.hidden = m!=="quiz"; el.pFlash.hidden = m!=="flash"; el.pCustom.hidden = m!=="custom";
  if(m!=="custom") resetGame();
}
function addCustom(){
  const rom=el.inRom.value.trim(), kr=el.inHan.value.trim(), id=el.inInd.value.trim();
  if(!rom||!kr||!id){ alert("Isi romaja, hangul, dan arti."); return; }
  const c=custom();
  (el.inCat.value==="vocab"? c.v:c.p).push({rom,kr,id});
  save(LS.v,c.v); save(LS.p,c.p);
  el.inRom.value=el.inHan.value=el.inInd.value="";
  alert("Ditambahkan! (tersimpan di perangkat)");
}

/* boot */
switchMode("quiz"); p1.name=el.p1name.value; p2.name=el.p2name.value; refreshNames();
</script>
</body>
</html>
